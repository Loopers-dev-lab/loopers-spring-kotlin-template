# 요구사항 분석 문서: PG 연동 Resilience 설계

## 1. 프로젝트 목표 정의

### 1.1 해결하고자 하는 문제
- 외부 시스템(PG) 연동 시 발생하는 장애 및 지연에 대한 대응 체계 부재
- PG 장애가 전체 주문 시스템으로 전파될 위험
- 비동기 결제 특성상 결제 상태와 주문 상태 간 불일치 발생 가능성

### 1.2 프로젝트 목표
- PG 장애가 발생해도 전체 주문 시스템이 멈추지 않도록 보호
- 비동기 결제 상태의 정합성 확보
- 장애 상황에 대한 운영 가시성 확보

### 1.3 성공 기준
- Timeout이 설계대로 동작하는가
- Circuit Breaker가 설계대로 동작하는가
- Fallback이 설계대로 동작하는가
- Retry가 설계대로 동작하는가

## 2. 도메인 용어집

| 용어 | 정의 |
|-----|-----|
| PG (Payment Gateway) | 카드사와 연동하여 결제를 대행하는 외부 시스템 |
| 비동기 결제 | 결제 요청과 실제 처리가 분리된 결제 방식. 요청 후 콜백으로 결과 수신 |
| 콜백 (Callback) | PG가 결제 처리 완료 후 우리 시스템에 결과를 전달하는 방식 |
| 결제 진행 중 | 결제 요청은 전송했으나 최종 결과가 확정되지 않은 상태 |
| 결제 성공 | PG로부터 결제 승인을 받은 상태 |
| 결제 실패 | PG로부터 결제 거절을 받은 상태 (한도 초과, 잘못된 카드 등) |

## 3. 유스케이스 명세

### 3.1 주요 사용자
- 구매자: 결제를 시도하는 사용자
- 운영자: 장애 상황을 모니터링하고 대응하는 사용자

### 3.2 구매자의 목표
- 카드로 상품을 결제할 수 있다
- 언제든지 결제 상태를 확인할 수 있다

### 3.3 운영자의 목표
- PG 연동 상태를 실시간으로 모니터링할 수 있다
- 장애 발생 시 빠르게 인지할 수 있다

### 3.4 유스케이스 상세

#### UC-1. 카드 결제

**유저 스토리**: As a 구매자, I want to 카드로 상품을 결제하고 싶다, So that 원하는 상품을 구매할 수 있다.

**인수 조건**:
- 카드 정보(카드사, 카드번호)와 주문 정보로 결제를 요청할 수 있다
- PG가 요청을 정상 수신하면 결제 진행 중 상태가 된다
- PG로부터 콜백을 수신하면 결제 성공/실패 상태로 변경된다
- 콜백이 일정 시간 내에 오지 않으면 스케줄러가 PG에 상태를 확인하여 결제 상태를 확정한다

**예외 상황**:
- 서킷 오픈 상태에서 결제 요청 시 롤백한다
- PG 요청 타임아웃 시 결제 진행 중 상태로 유지하고, 스케줄러를 통해 상태를 확정한다
- 한도 초과, 잘못된 카드 등 PG 거절 시 결제 실패 처리하고 사유를 안내한다

#### UC-2. 주문 상세 조회

**유저 스토리**: As a 구매자, I want to 주문 상세 정보를 조회하고 싶다, So that 결제 상태를 포함한 주문 현황을 확인할 수 있다.

**인수 조건**:
- 주문 ID로 주문 상세 정보를 조회할 수 있다
- 주문 상세에는 결제 상태(결제 진행 중, 결제 성공, 결제 실패)가 포함된다
- 주문 상세에는 주문 정보(상품, 수량, 금액 등)가 포함된다

**예외 상황**:
- 존재하지 않는 주문 ID 조회 시 에러를 반환한다
- 본인의 주문이 아닌 경우 에러를 반환한다

#### UC-3. PG 연동 상태 모니터링

**유저 스토리**: As a 운영자, I want to PG 연동 상태를 실시간으로 모니터링하고 싶다, So that 시스템 상태를 파악할 수 있다.

**인수 조건**:
- Grafana 대시보드에서 PG 요청 성공/실패 현황을 확인할 수 있다
- 서킷브레이커 상태(CLOSED, OPEN, HALF_OPEN)를 확인할 수 있다
- Prometheus에 PG 요청 fail count가 커스텀 메트릭으로 적재된다
- 서킷브레이커 상태 변경 시마다 로그가 출력된다
- 서킷 오픈 시 오픈 사유가 로그에 기록된다

#### UC-4. 장애 알림

**유저 스토리**: As a 운영자, I want to 장애 발생 시 알림을 받고 싶다, So that 빠르게 대응할 수 있다.

**인수 조건**:
- 서킷이 오픈되면 알림을 받을 수 있다
- PG 요청 실패율이 임계치를 초과하면 알림을 받을 수 있다

## 4. 기술 요구사항 명세

### 4.1 데이터 정합성
- PG에서 결제 성공/실패가 확정되면 우리 시스템의 주문 상태도 일정 시간 내에 동일하게 반영되어야 한다
- 콜백이 오지 않는 경우에도 스케줄러를 통해 최종적으로 상태가 일치해야 한다

### 4.2 에러 처리
- 서킷 오픈 상태: 롤백 (요청이 PG에 전달되지 않음이 보장됨)
- PG 요청 타임아웃: 결제 진행 중 상태로 유지, 스케줄러를 통해 상태 확정 (요청 도달 여부 불확실)
- PG 거절 응답(한도 초과, 잘못된 카드 등): 결제 실패 처리 및 사유 안내
- 콜백 미수신: 스케줄러가 PG 상태 확인 API로 상태 확정
- Retry 대상: 일시적 네트워크 오류 등 재시도 가능한 실패
- Retry 제외: PG 거절 응답 (재시도해도 결과가 같음)

### 4.3 모니터링

**수집 메트릭**:
- PG 요청 fail count (Prometheus 커스텀 메트릭)
- 서킷브레이커 상태 (CLOSED, OPEN, HALF_OPEN)

**로그**:
- 서킷브레이커 상태 변경 시마다 로그 출력
- 서킷 오픈 시 오픈 사유 로그 기록

**알람 조건**:
- 서킷 오픈 시
- PG 요청 실패율 임계치 초과 시
