# 요구사항 명세서

---
## 유비쿼터스 언어
| 한글 용어 | 영문 용어 | 설명 |
|---------|---------|-----|
| 브랜드 | Brand | 상품을 제공하는 브랜드 (상품의 필수 소속) |
| 상품 | Product | 판매하는 아이템 (재고, 가격 정보 포함) |
| 좋아요 | Like | 사용자가 상품에 표시하는 관심 표시 |
| 주문 | Order | 사용자가 상품을 구매하는 행위 및 기록 |
| 주문상품 | OrderItem | 주문 생성 시점의 상품 정보 스냅샷 (불변) |
| 회원 | User | 서비스를 이용하는 사용자 |
| 포인트 | Point | 결제 수단으로 사용되는 가상 화폐 |
| 포인트 트랜잭션 | PointTransaction | 포인트 충전/사용/환불 등의 모든 변경 이력 |
| 재고 | Stock | 상품의 판매 가능 수량 |
| 결제 | Payment | 주문 시 포인트 차감 처리 |

## 핵심 비즈니스 규칙

### 브랜드 관리
- 브랜드는 상품의 **필수 속성**이다
- 브랜드가 없는 상품은 존재할 수 없다
- 브랜드는 여러 상품을 가질 수 있다 (1:N 관계)

### 재고 관리
- 재고는 **음수가 될 수 없다**
- 품절 상태(재고 0)인 상품은 주문할 수 없다

### 포인트 관리
- 포인트는 **음수가 될 수 없다**
- 주문 금액보다 포인트가 적으면 주문 불가
- 모든 포인트 변경은 **트랜잭션 이력으로 기록**된다 (감사 추적)
- 포인트 트랜잭션은 **변경 전/후 잔액을 필수로 기록**한다

### 좋아요 관리
- 사용자당 상품당 **하나의 좋아요만** 가능

### 주문상품 관리
- 주문 생성 시점의 상품 정보를 **스냅샷**으로 저장한다
- 상품 가격 변경이나 삭제와 무관하게 **주문 당시 정보를 유지**한다

---
## 도메인 목록

**1. User (회원)**

**2. Brand (브랜드)**

**3. Products (상품)**

**4. Point (포인트)**

**5. PointTransaction (포인트 트랜잭션)**

**6. Stock (재고)**

**7. Like (좋아요)**

**8. Orders (주문)**

**9. OrderItem (주문상품)**

**10. Payment (결제)**

---

## 도메인별 요구사항

### 1. User (회원)

- 사용자는 **회원 정보**를 조회할 수 있다
- 사용자는 **회원 목록**을 조회할 수 있다
- 사용자는 주문, 좋아요, 포인트 등의 **소유자**이다
- 사용자는 **포인트**를 보유한다

#### 기능 흐름

**[회원 조회]**
1. 회원 ID로 조회 요청
2. 해당 회원이 존재하면 회원 정보 반환
3. 존재하지 않으면 오류 응답

**[회원 목록 조회]**
1. 전체 회원 목록 조회
2. 각 회원의 기본 정보 반환 (이름, 이메일, 가입일)

#### 예외 처리

- 존재하지 않는 회원 ID로 조회 시 오류
- 잘못된 ID 형식(숫자가 아닌 값) 입력 시 오류

---

### 2. Point (포인트)

- 사용자는 **자신의 포인트**를 조회할 수 있다
- 사용자는 **포인트를 충전**할 수 있다
- 포인트는 **음수가 될 수 없다**
- 주문 시 **포인트가 차감**된다
- 포인트는 **사용자에 종속**되며, 사용자 없이 독립적으로 존재할 수 없다
- 모든 포인트 변경은 **트랜잭션 이력**으로 기록된다

#### 기능 흐름

**[포인트 조회]**
1. 로그인한 사용자만 가능
2. 현재 사용자의 포인트 잔액 조회
3. 포인트 정보 반환 (잔액, 최종 업데이트 일시)

**[포인트 충전]**
1. 로그인한 사용자만 가능
2. 충전할 포인트 금액 입력 (양수만 가능)
3. 현재 포인트에 충전 금액 추가
4. 포인트 트랜잭션 생성 (타입: CHARGE, 변경 전/후 잔액 기록)
5. 충전 완료 응답 (충전 후 잔액)

**[포인트 차감]**
1. 주문 생성 시 자동으로 수행
2. 현재 포인트 잔액 확인
3. 주문 금액 ≤ 보유 포인트 → 차감 진행
4. 주문 금액 > 보유 포인트 → 차감 실패
5. 차감 성공 시 포인트 트랜잭션 생성 (타입: USE, 주문ID, 변경 전/후 잔액 기록)

**[포인트 트랜잭션 이력 조회]**
1. 로그인한 사용자만 가능
2. 현재 사용자의 모든 포인트 변경 이력 조회
3. 트랜잭션 정보 반환 (타입, 금액, 변경 전/후 잔액, 날짜, 주문ID)
4. 최신순으로 정렬

#### 예외 처리

- 포인트가 부족한 상태에서 차감 시도 시 오류
- 0원 이하 금액 충전 시도 시 오류
- 비로그인 사용자가 포인트 조회/충전 시도 시 오류

---

### 3. Stock (재고)

- 재고는 **상품에 종속**되며, 상품 없이 독립적으로 존재할 수 없다
- 재고는 **음수가 될 수 없다**
- 주문 시 **재고가 차감**된다
- 재고가 0이면 **품절 상태**이다

#### 기능 흐름

**[재고 조회]**
1. 상품 ID로 재고 정보 조회
2. 재고 수량 반환

**[재고 증가]**
1. 상품 입고 시 재고 증가
2. 증가할 수량 입력 (양수만 가능)
3. 현재 재고에 입고 수량 추가
4. 증가 완료 응답

**[재고 차감]**
1. 주문 생성 시 자동으로 수행
2. 현재 재고 수량 확인 (비관적 락)
3. 주문 수량 ≤ 현재 재고 → 차감 진행
4. 주문 수량 > 현재 재고 → 차감 실패

#### 예외 처리

- 재고가 부족한 상태에서 차감 시도 시 오류
- 0개 이하 수량 증가 시도 시 오류
- 존재하지 않는 상품의 재고 조회 시 오류

---

### 4. Payment (결제)

- 결제는 **주문에 종속**되며, 주문 없이 독립적으로 존재할 수 없다
- 결제는 **포인트 차감**으로 이루어진다
- 결제는 **상태**를 가진다 (대기, 완료, 실패, 취소)
- 결제 실패 시 **포인트 및 재고가 롤백**된다

#### 기능 흐름

**[결제 생성]**
1. 주문 생성 시 자동으로 수행
2. 결제 엔티티 생성 (상태: 대기)
3. 포인트 차감 시도
4. 포인트 차감 성공 → 결제 상태를 완료로 변경
5. 포인트 차감 실패 → 결제 상태를 실패로 변경

**[결제 조회]**
1. 주문 ID로 결제 정보 조회
2. 결제 정보 반환 (결제 금액, 결제 수단, 결제 상태, 결제 일시)

**[결제 취소]**
1. 주문 취소 시 자동으로 수행
2. 결제 상태가 완료인지 확인
3. 포인트 환불 처리
4. 결제 상태를 취소로 변경

#### 예외 처리

- 이미 취소된 결제를 다시 취소 시도 시 오류
- 완료되지 않은 결제를 취소 시도 시 오류
- 존재하지 않는 결제 조회 시 오류

---

### 5. Brand (브랜드)

- 사용자는 **브랜드 정보**를 조회할 수 있다
- 사용자는 **브랜드 목록**을 조회할 수 있다
- 브랜드는 **여러 상품**을 가질 수 있다

#### 기능 흐름

**[브랜드 조회]**
1. 사용자가 브랜드 ID로 조회 요청
2. 해당 브랜드가 존재하면 브랜드 정보 반환
3. 존재하지 않으면 오류 응답

**[브랜드 목록 조회]**
1. 모든 사용자가 조회 가능 (비로그인 포함)
2. 전체 브랜드 목록을 반환
3. 각 브랜드의 기본 정보 포함 (브랜드명, 설명)

#### 예외 처리

- 존재하지 않는 브랜드 ID로 조회 시 오류
- 잘못된 ID 형식(숫자가 아닌 값) 입력 시 오류

---

### 2. Products (상품)

- 사용자는 전체 **상품 목록**을 조회할 수 있다
- 사용자는 **특정 상품의 상세 정보**를 조회할 수 있다
- 상품은 **브랜드에 속해** 있으며, 브랜드별로 상품을 구분할 수 있다
- 상품은 **브랜드에 속해 있고 브랜드가 없으면 상품은 존재할 수 없다**
- 상품은 **재고 수량**을 가지며, 재고가 0이면 품절 상태이다

#### 기능 흐름

**[상품 목록 조회]**
1. 모든 사용자가 조회 가능 (비로그인 포함)
2. 전체 상품 목록을 반환
3. 각 상품의 기본 정보 포함 (상품명, 가격, 브랜드명, 재고 여부)

**[상품 상세 조회]**
1. 사용자가 상품 ID로 조회 요청
2. 해당 상품이 존재하면 상세 정보 반환 (상품명, 가격, 설명, 브랜드 정보, 재고 수량)
3. 존재하지 않으면 오류 응답

#### 예외 처리

- 존재하지 않는 상품 ID로 조회 시 오류
- 잘못된 ID 형식(숫자가 아닌 값) 입력 시 오류

---

### 3. Like (좋아요)

- 사용자는 **상품에 좋아요**를 등록할 수 있다
- 사용자는 **이미 좋아요한 상품의 좋아요를 취소**할 수 있다
- 사용자는 **내가 좋아요한 상품 목록**을 조회할 수 있다
- 좋아요는 **로그인한 사용자만** 가능하다

#### 기능 흐름

**[상품 좋아요 등록]**
1. 로그인한 사용자만 가능 (비로그인 시 오류)
2. 좋아요할 상품 ID 전달
3. 해당 상품이 존재하는지 확인
4. 이미 좋아요한 상품인지 확인
   - 없으면 → 좋아요 저장
   - 있으면 → 좋아요 취소
5. 성공 응답 반환

**[내가 좋아요한 상품 목록 조회]**
1. 로그인한 사용자만 가능
2. 현재 사용자가 좋아요한 모든 상품 조회
3. 상품 정보와 함께 반환 (상품명, 가격, 브랜드명)

#### 예외 처리

- 비로그인 사용자가 좋아요 시도 시 오류
- 존재하지 않는 상품에 좋아요 시도 시 오류

---

### 4. Orders (주문)

- 사용자는 **상품을 주문**할 수 있다
- 주문 시 **포인트로 결제**가 이루어진다
- 주문이 완료되면 **재고가 차감**된다
- 주문이 완료되면 **포인트가 차감**된다
- 주문 생성 시 **주문상품(OrderItem) 정보가 함께 저장**된다
- 주문 중 하나라도 실패하면 **전체 롤백**된다 (트랜잭션)
- 사용자는 **자신의 주문 목록**을 조회할 수 있다
- 사용자는 **특정 주문의 상세 정보**를 조회할 수 있다
- 재고가 부족하거나 포인트가 부족하면 **주문이 실패**한다

#### 기능 흐름

**[주문 생성]**
1. 로그인한 사용자만 가능
2. 주문할 상품 정보 전달 (상품 ID, 수량)
3. 상품 존재 여부 확인
4. **재고 검증**
   - 주문 수량 ≤ 현재 재고 → 진행
   - 주문 수량 > 현재 재고 → 재고 부족 오류
5. **포인트 검증**
   - 사용자 보유 포인트 조회
   - 주문 총액 ≤ 보유 포인트 → 진행
   - 주문 총액 > 보유 포인트 → 포인트 부족 오류
6. **주문 생성 및 결제 처리** (트랜잭션)
   - 주문 엔티티 생성 (상태: 결제 완료)
   - 재고 차감
   - 포인트 차감
   - 주문상품(OrderItem) 생성 (상품 정보 스냅샷 저장)
7. **외부 시스템 연동** 
   - 주문 이벤트 발행 (Kafka 등)
8. 주문 결과 반환 (주문 ID, 주문 상태, 결제 금액)

**[주문 목록 조회]**
1. 로그인한 사용자만 가능
2. 현재 사용자의 모든 주문 내역 조회
3. 주문 기본 정보 반환 (주문 ID, 주문 일시, 총 금액, 주문 상태)
4. 최신 주문 순으로 정렬

**[주문 상세 조회]**
1. 로그인한 사용자만 가능
2. 주문 ID로 조회
3. 본인의 주문인지 확인 (다른 사람 주문 조회 방지)
4. 주문 상세 정보 반환
   - 주문 정보 (주문 ID, 주문 일시, 상태)
   - 주문상품 정보 (OrderItem에서 조회: 상품명, 수량, 단가, 합계)
   - 결제 정보 (총 결제 금액, 사용 포인트)

#### 예외 처리

- 비로그인 사용자가 주문 시도 시 오류
- 존재하지 않는 상품 주문 시 오류
- 재고 부족 시 → "재고가 부족합니다"
- 포인트 부족 시 "포인트가 부족합니다"
- 주문 수량이 0 이하일 때 "주문 수량은 1 이상이어야 합니다"
- 다른 사용자의 주문 조회 시 오류
- 존재하지 않는 주문 조회 시 오류

---

### 5. OrderItem (주문상품)

- OrderItem은 **주문 생성 시점의 상품 정보**를 스냅샷으로 저장한다
- 상품이 삭제되거나 가격이 변경되어도 **주문 당시의 정보를 보존**한다
- OrderItem은 **주문(Order)에 종속**되며, 주문 없이 독립적으로 존재할 수 없다
- 하나의 주문은 **여러 개의 OrderItem**을 가질 수 있다 (1:N 관계)

#### 기능 흐름

**[OrderItem 생성]**
1. 주문 생성 시 생성됨
2. 현재 시점의 상품 정보를 조회
3. 상품 정보를 스냅샷으로 저장
   - 상품 ID (참조용)
   - 상품명 (주문 당시)
   - 브랜드명 (주문 당시)
   - 상품 가격 (주문 당시)
   - 주문 수량
   - 총 금액 (가격 × 수량)

**[OrderItem 조회]**
1. 주문 상세 조회 시 함께 조회됨
2. 주문 ID로 해당 주문의 모든 OrderItem 조회
3. 스냅샷된 상품 정보 반환

#### 예외 처리

- OrderItem은 Order 없이 생성될 수 없음
