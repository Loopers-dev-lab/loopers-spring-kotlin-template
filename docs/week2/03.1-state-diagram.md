# ìƒíƒœ ë‹¤ì´ì–´ê·¸ë¨ (State Diagrams)

ë³¸ ë¬¸ì„œëŠ” ê°ì„± ì´ì»¤ë¨¸ìŠ¤ì˜ í•µì‹¬ ì—”í‹°í‹°ë“¤ì˜ ìƒíƒœ ì „ì´ë¥¼ ì‹œê°í™”í•©ë‹ˆë‹¤.

---

## 1. Product ìƒíƒœ ë‹¤ì´ì–´ê·¸ë¨

```mermaid
stateDiagram-v2
    [*] --> ACTIVE: Product.create()<br/>(ì¬ê³  > 0)
    [*] --> OUT_OF_STOCK: Product.create()<br/>(ì¬ê³  = 0)
    ACTIVE --> OUT_OF_STOCK: decreaseStock()<br/>(ì¬ê³  â†’ 0)
    OUT_OF_STOCK --> ACTIVE: increaseStock()<br/>(ì¬ê³  > 0)
    note right of ACTIVE
        íŒë§¤ ê°€ëŠ¥ ìƒíƒœ
        stock.amount > 0
    end note
    note right of OUT_OF_STOCK
        í’ˆì ˆ ìƒíƒœ
        stock.amount = 0
        ì¬ì…ê³  ì‹œ ACTIVEë¡œ ìë™ ì „ì´
    end note
```

### ìƒíƒœ ì •ì˜

```kotlin
enum class ProductStatus {
    ACTIVE,           // íŒë§¤ ì¤‘
    OUT_OF_STOCK,     // í’ˆì ˆ
}
```

### ìƒíƒœ ì „ì´ ì¡°ê±´

| í˜„ì¬ ìƒíƒœ        | ì´ë²¤íŠ¸              | ë‹¤ìŒ ìƒíƒœ        | ì „ì´ ì¡°ê±´                    |
|--------------|------------------|--------------|--------------------------|
| -            | Product.create() | ACTIVE       | stock.amount > 0         |
| -            | Product.create() | OUT_OF_STOCK | stock.amount = 0         |
| ACTIVE       | decreaseStock()  | OUT_OF_STOCK | ì¬ê³  ì°¨ê° í›„ stock.amount = 0 |
| OUT_OF_STOCK | increaseStock()  | ACTIVE       | ì¬ê³  ì¦ê°€ í›„ stock.amount > 0 |

**ì„¤ê³„ íŠ¹ì§•:**

- âœ… **ë‹¨ìˆœì„±**: ì¬ê³  ìˆ˜ëŸ‰ë§Œìœ¼ë¡œ ACTIVE â†” OUT_OF_STOCK ì „ì´

---

## 2. Order ìƒíƒœ ë‹¤ì´ì–´ê·¸ë¨

```mermaid
stateDiagram-v2
    [*] --> PAID: Order.paid()<br/>(ì£¼ë¬¸ ìƒì„±)
    PAID --> [*]: ì£¼ë¬¸ ì™„ë£Œ
    note right of PAID
        ìƒì„± ì¦‰ì‹œ ê²°ì œ ì™„ë£Œ ìƒíƒœ
        ì „ì•¡ í¬ì¸íŠ¸ ê²°ì œë§Œ ì§€ì›

        íŠ¸ëœì­ì…˜ ë‚´ì—ì„œ:
        1. ì¬ê³  ì°¨ê° (Product.decreaseStock)
        2. í¬ì¸íŠ¸ ì°¨ê° (PointAccount.deduct)
        3. ì£¼ë¬¸ ìƒì„± (Order.paid)
        4. ê²°ì œ ìƒì„± (Payment.paid)

        ì‹¤íŒ¨ ì‹œ ì „ì²´ ë¡¤ë°±
    end note
```

### ìƒíƒœ ì •ì˜

```kotlin
enum class OrderStatus {
    PAID  // ê²°ì œ ì™„ë£Œ (ìœ ì¼í•œ ìƒíƒœ)
}
```

### ì£¼ë¬¸ ìƒì„± ê³¼ì •

```kotlin
@Transactional
fun createOrder(userId: Long, items: List<OrderItemRequest>, usePoint: Money): Order {
    // 1. ì¬ê³  ì°¨ê°
    items.forEach { item ->
        val product = productRepository.findByIdForUpdate(item.productId)
        product.decreaseStock(item.quantity)
        productRepository.save(product)
    }

    // 2. í¬ì¸íŠ¸ ì°¨ê°
    val pointAccount = pointAccountRepository.findByUserIdForUpdate(userId)
    pointAccount.deduct(usePoint)
    pointAccountRepository.save(pointAccount)

    // 3. ì£¼ë¬¸ ìƒì„± (PAID ìƒíƒœ)
    val order = Order.paid(userId, orderItems)
    orderRepository.save(order)

    // 4. ê²°ì œ ìƒì„± (PAID ìƒíƒœ)
    val payment = Payment.paid(userId, order, usePoint)
    paymentRepository.save(payment)

    return order
}
```

**ì„¤ê³„ íŠ¹ì§•:**

- âš¡ **ë™ê¸° ì²˜ë¦¬**: ì£¼ë¬¸ ìƒì„± = ê²°ì œ ì™„ë£Œ (ë‹¨ì¼ íŠ¸ëœì­ì…˜)
- ğŸ”’ **ì›ìì„±**: ì¬ê³ /í¬ì¸íŠ¸/ì£¼ë¬¸/ê²°ì œ ëª¨ë‘ ì„±ê³µ or ëª¨ë‘ ì‹¤íŒ¨
- ğŸ’° **ì „ì•¡ í¬ì¸íŠ¸**: ì™¸ë¶€ PG ì—°ë™ ì—†ì´ ì¦‰ì‹œ ì™„ë£Œ
- âŒ **ì·¨ì†Œ ë¶ˆê°€**: ì£¼ë¬¸ ì·¨ì†Œ, ë°˜í’ˆ ê¸°ëŠ¥ ë¯¸ì§€ì›

**ì œì•½ì‚¬í•­:**

- ì£¼ë¬¸ í›„ ì·¨ì†Œ ë¶ˆê°€
- ë°°ì†¡ ìƒíƒœ ì¶”ì  ë¶ˆê°€
- ë¶€ë¶„ í™˜ë¶ˆ ë¶ˆê°€
- êµ¬ë§¤ í™•ì • ê°œë… ì—†ìŒ

---

## 3. Payment ìƒíƒœ ë‹¤ì´ì–´ê·¸ë¨

```mermaid
stateDiagram-v2
    [*] --> PAID: Payment.paid()<br/>(ê²°ì œ ìƒì„±)
    PAID --> [*]: ê²°ì œ ì™„ë£Œ
    note right of PAID
        ìƒì„± ì¦‰ì‹œ ì™„ë£Œ ìƒíƒœ

        ê²€ì¦:
        - usedPoint = totalAmount
        (ì „ì•¡ í¬ì¸íŠ¸ ê²°ì œë§Œ í—ˆìš©)

        Orderì™€ 1:1 ê´€ê³„
    end note
```

### ìƒíƒœ ì •ì˜

```kotlin
enum class PaymentStatus {
    PAID  // ê²°ì œ ì™„ë£Œ (ìœ ì¼í•œ ìƒíƒœ)
}
```

### ê²°ì œ ìƒì„± ë¡œì§

```kotlin
class Payment {
    companion object {
        fun paid(userId: Long, order: Order, usedPoint: Money): Payment {
            // ì „ì•¡ í¬ì¸íŠ¸ ê²€ì¦
            if (usedPoint < Money.ZERO_KRW) {
                throw CoreException(ErrorType.BAD_REQUEST, "ì‚¬ìš© í¬ì¸íŠ¸ëŠ” 0 ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.")
            }

            if (usedPoint != order.totalAmount) {
                throw CoreException(ErrorType.BAD_REQUEST, "ì‚¬ìš© í¬ì¸íŠ¸ê°€ ì£¼ë¬¸ ê¸ˆì•¡ê³¼ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.")
            }

            return Payment(
                orderId = order.id,
                userId = userId,
                totalAmount = order.totalAmount,
                usedPoint = usedPoint,
                status = PaymentStatus.PAID  // ìƒì„± ì¦‰ì‹œ PAID
            )
        }
    }
}
```

**ì„¤ê³„ íŠ¹ì§•:**

- ğŸ’° **ì „ì•¡ í¬ì¸íŠ¸**: `usedPoint == totalAmount` ê²€ì¦
- âš¡ **ì¦‰ì‹œ ì™„ë£Œ**: ìƒì„± ì‹œì  = ê²°ì œ ì™„ë£Œ
- ğŸ”— **Order ì¢…ì†**: Orderì™€ ìƒëª…ì£¼ê¸° ë™ì¼
- âŒ **PG ì—†ìŒ**: ì™¸ë¶€ ê²°ì œ ì‹œìŠ¤í…œ ì—°ë™ ì—†ìŒ

**ì œì•½ì‚¬í•­:**

- ì¹´ë“œ/ê³„ì¢Œì´ì²´ ë“± ì™¸ë¶€ ê²°ì œ ìˆ˜ë‹¨ ë¯¸ì§€ì›
- ê²°ì œ ì‹¤íŒ¨ ìƒíƒœ ì—†ìŒ (íŠ¸ëœì­ì…˜ ë¡¤ë°±)
- ë¶€ë¶„ ê²°ì œ ë¶ˆê°€
- í™˜ë¶ˆ ê¸°ëŠ¥ ë¯¸ì§€ì›

