---
creation date: 2025-11-21 01:07:57
modification date: 2025-11-21 01:07:57
projects: []
areas:
resources:
tags:
to card: false
---
# 쿠폰 시스템 상세 설계 및 구현 계획 문서

## 1. 시스템 플로우차트

### 1.1 쿠폰 발급 플로우

```mermaid
flowchart TD
    Start([쿠폰 발급 요청]) --> ValidateInput{입력 검증}
    
    ValidateInput -->|유효하지 않음| InputError[입력 오류]
    InputError --> End1([400 Bad Request])
    
    ValidateInput -->|유효| CheckCouponExists{쿠폰 존재?}
    
    CheckCouponExists -->|존재하지 않음| CouponNotFound[쿠폰 미존재]
    CouponNotFound --> End2([404 Not Found])
    
    CheckCouponExists -->|존재| CheckDuplicate{이미 발급?}
    
    CheckDuplicate -->|이미 발급됨| AlreadyIssued[중복 발급]
    AlreadyIssued --> End3([409 Conflict])
    
    CheckDuplicate -->|미발급| IssueNow[발급 처리]
    IssueNow --> SaveDB[DB 저장]
    SaveDB --> End4([200 OK])
```

### 1.2 주문 생성 시 쿠폰 사용 - 정상 플로우

```mermaid
flowchart TD
    Start([주문 생성 요청<br/>couponId 포함]) --> TxBegin[트랜잭션 시작]
    
    TxBegin --> CheckStock{재고 충분?}
    CheckStock -->|부족| StockError[재고 부족]
    StockError --> Rollback1[트랜잭션 롤백]
    Rollback1 --> End1([400 Bad Request])
    
    CheckStock -->|충분| DeductStock[재고 차감<br/>FOR UPDATE]
    DeductStock --> CalcAmount[주문 금액 계산]
    
    CalcAmount --> HasCoupon{쿠폰 ID<br/>존재?}
    
    HasCoupon -->|없음| UsePoints
    
    HasCoupon -->|있음| FetchIssuedCoupon[IssuedCoupon 조회<br/>FOR UPDATE<br/>version 확인]
    
    FetchIssuedCoupon --> CheckCouponStatus{쿠폰<br/>사용 가능?}
    
    CheckCouponStatus -->|미보유| CouponNotFound[쿠폰 미보유]
    CouponNotFound --> Rollback2[트랜잭션 롤백]
    Rollback2 --> End2([404 Not Found])
    
    CheckCouponStatus -->|이미 사용| CouponUsed[쿠폰 이미 사용]
    CouponUsed --> Rollback3[트랜잭션 롤백]
    Rollback3 --> End3([400 Bad Request])
    
    CheckCouponStatus -->|사용 가능| FetchCoupon[Coupon 조회]
    FetchCoupon --> CalcDiscount[할인 금액 계산]
    CalcDiscount --> UpdateCouponStatus[쿠폰 상태 USED로 변경<br/>used_at 기록<br/>version 증가]
    UpdateCouponStatus --> CalcFinal[최종 결제 금액 계산]
    
    CalcFinal --> UsePoints[포인트 차감 시도<br/>FOR UPDATE]
    UsePoints --> CheckPoint{포인트<br/>충분?}
    
    CheckPoint -->|부족| PointError[포인트 부족]
    PointError --> Rollback4[트랜잭션 롤백]
    Rollback4 --> End4([400 Bad Request])
    
    CheckPoint -->|충분| CreateOrder[주문 생성]
    CreateOrder --> Commit[트랜잭션 커밋]
    Commit --> End5([200 OK])
```

### 1.3 주문 생성 시 쿠폰 사용 - 낙관적 락 충돌

```mermaid
flowchart TD
    Start([쿠폰 사용 시도]) --> UpdateCoupon[IssuedCoupon 업데이트<br/>WHERE id = ? AND version = ?]
    
    UpdateCoupon --> CheckUpdate{업데이트<br/>성공?}
    
    CheckUpdate -->|실패<br/>version 불일치| OptimisticLockError[낙관적 락 충돌]
    OptimisticLockError --> LogWarn[WARN 로그 기록]
    
    LogWarn --> Retry{재시도<br/>1회?}
    
    Retry -->|예| RetryOnce[재시도]
    RetryOnce --> UpdateCoupon
    
    Retry -->|아니오| FinalError[최종 실패]
    FinalError --> End1([400 Bad Request<br/>동시성 충돌])
    
    CheckUpdate -->|성공| Continue[쿠폰 사용 완료]
    Continue --> End2([계속 진행])
```

## 2. 데이터 모델 설계

### 2.1 테이블 스키마

#### coupon 테이블

```sql
CREATE TABLE coupon (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    discount_type VARCHAR(20) NOT NULL,
    discount_value BIGINT NOT NULL,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    deleted_at TIMESTAMPTZ
);
```

**컬럼 설명:**

- `id`: 쿠폰 고유 식별자
- `name`: 쿠폰 이름 (예: "신규 가입 5,000원 할인")
- `discount_type`: 할인 타입 (`FIXED_AMOUNT`, `RATE`)
- `discount_value`: 할인 값 (정액: 5000, 정률: 10)
- `created_at`: 생성 시각
- `updated_at`: 수정 시각
- `deleted_at`: 삭제 시각 (Soft Delete)

#### issued_coupon 테이블

```sql
CREATE TABLE issued_coupon (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL,
    coupon_id BIGINT NOT NULL REFERENCES coupon(id),
    status VARCHAR(20) NOT NULL,
    used_at TIMESTAMPTZ,
    version BIGINT NOT NULL DEFAULT 0,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    deleted_at TIMESTAMPTZ,
    
    -- 중복 발급 방지 (재발급 불가 정책)
    CONSTRAINT uk_user_coupon UNIQUE (user_id, coupon_id)
);
```

**컬럼 설명:**

- `id`: 발급된 쿠폰 고유 식별자
- `user_id`: 사용자 ID
- `coupon_id`: 쿠폰 정의 참조
- `status`: 사용 상태 (`AVAILABLE`, `USED`)
- `used_at`: 사용 시각
- `version`: 낙관적 락 버전
- `created_at`: 발급 시각
- `updated_at`: 수정 시각
- `deleted_at`: 삭제 시각 (Soft Delete)

### 2.2 인덱스 전략

**issued_coupon 테이블:**

- `uk_user_coupon` UNIQUE 제약조건이 `(user_id, coupon_id)` 복합 인덱스를 자동 생성
- 보유 쿠폰 조회 시 선두 컬럼인 `user_id`로 인덱스 활용 가능

## 3. 운영 계획

### 3.1 로깅 전략

낙관적 락 충돌 발생 시 WARN 레벨로 로깅합니다.

```
WARN: OptimisticLockException occurred for issuedCouponId={}, attempt={}
```

**이유:**

- 충돌 발생 빈도를 추적하여 낙관적 락 전략의 적절성을 검증
- 충돌이 빈번하다면 동시성 제어 전략 재검토 필요

### 3.2 주요 실패 시나리오 및 대응 계획

|실패 시나리오|대응 방안|기대 효과|
|---|---|---|
|낙관적 락 충돌|• 최대 1회 재시도<br/>• 실패 시 400 Bad Request 응답|• 일시적 충돌은 자동 해결<br/>• 지속적 충돌은 클라이언트에 명확히 전달|
|재고 부족으로 주문 실패|• 트랜잭션 롤백으로 쿠폰 사용 자동 취소<br/>• 쿠폰 상태 원복 (AVAILABLE)|• 쿠폰 재사용 가능<br/>• 데이터 일관성 유지|
|포인트 부족으로 결제 실패|• 트랜잭션 롤백으로 쿠폰 사용 자동 취소<br/>• 재고 차감도 함께 롤백|• 쿠폰 재사용 가능<br/>• 전체 주문 플로우 원자성 보장|
|중복 발급 시도|• DB UNIQUE 제약조건으로 원천 차단<br/>• 409 Conflict 응답|• 동시 요청에도 안전<br/>• 애플리케이션 로직 오류 방지|

## 4. 설계 결정 공유

### 4.1 주요 설계 결정 및 근거

|설계 결정|근거|
|---|---|
|낙관적 락 사용|• 동일 사용자가 동시에 같은 쿠폰을 사용하는 경우는 거의 없음<br/>• 락 프리는 불가능 (쿠폰 상태 변경이 필요하므로)<br/>• 비관적 락은 과함 (충돌 빈도가 낮아 DB 락의 성능 오버헤드가 불필요)<br/>• 충돌 발생 시 실패하는 것이 올바른 비즈니스 동작|
|UNIQUE 제약조건으로<br/>중복 발급 방지|• DB 레벨에서 원천적으로 차단<br/>• 동시 발급 요청에도 안전<br/>• 비즈니스 핵심 규칙이므로 DB에서 보장|