# 요구사항 분석 문서

> **Round 8**: Kafka 기반 이벤트 파이프라인

## 1. 프로젝트 목표 정의

### 1.1 해결하고자 하는 문제

이벤트 배치 처리를 위해 Kafka를 이벤트 소싱 채널로 활용하여 streamer 모듈에서 처리할 수 있는 구조가 필요하다. 또한 현재 시스템의 데이터 정합성을 Eventual Consistency 모델로 보장하여 최종적 일관성을 강화해야 한다.

### 1.2 프로젝트 목표

Transactional Outbox Pattern을 통해 도메인 트랜잭션과 이벤트 발행의 원자성을 확보하고, 네트워크 장애나 Kafka 일시 장애 상황에서도 이벤트 유실을 방지한다. 좋아요 수, 판매량, 조회수 등의 Metrics를 이벤트 기반으로 정확하게 집계하며, commerce-api와 streamer 모듈을 분리하여 독립적 스케일링과 향후 Consumer 확장이 용이한 구조를 구축한다.

## 2. 핵심 기능 요구사항

### 2.1 Producer

도메인 이벤트 발행 시 Transactional Outbox Pattern을 적용하여 트랜잭션과 이벤트 발행의 원자성을 보장한다. Outbox 테이블의 미발행 이벤트를 Kafka로 릴레이한다. PartitionKey 기반으로 동일 엔티티의 이벤트 순서를 보장한다.

### 2.2 Consumer

manual Ack으로 이벤트 수신을 처리한다. event_handled 테이블을 통해 중복 이벤트를 멱등하게 처리한다. version/updated_at 기준으로 최신 이벤트만 반영한다. product_metrics 테이블에 집계 데이터를 upsert한다 (좋아요 수, 판매량, 조회수). 재고 소진 시 상품 캐시를 무효화한다. 메시지 배치 처리를 지원한다. 처리 실패 메시지는 DLQ로 전송한다.

## 3. 유스케이스 명세

### 3.1 주요 사용자

구매자와 시스템이 주요 사용자이다.

### 3.2 구매자의 목표

상품의 좋아요 수를 정확하게 확인할 수 있다. 상품의 판매량을 정확하게 확인할 수 있다. 재고 소진된 상품은 즉시 품절로 표시된다.

### 3.3 시스템의 목표

상품별 조회수를 집계한다.

### 3.4 유스케이스 상세

**유저 스토리 1: 좋아요 집계 반영**

As a 구매자, I want to 상품의 정확한 좋아요 수를 확인하고 싶다, So that 다른 사람들의 관심도를 참고하여 구매 결정을 할 수 있다.

**인수 조건:**

- 좋아요 등록 이벤트 발생 시 해당 상품의 좋아요 수가 증가한다
- 좋아요 취소 이벤트 발생 시 해당 상품의 좋아요 수가 감소한다
- 동일 이벤트가 중복 수신되어도 집계는 한 번만 반영된다

**예외 상황:**

- 이벤트 처리 실패 시 DLQ로 전송된다

---

**유저 스토리 2: 판매량 집계 반영**

As a 구매자, I want to 상품의 판매량을 확인하고 싶다, So that 인기 있는 상품인지 참고하여 구매 결정을 할 수 있다.

**인수 조건:**

- 주문 완료 이벤트 발생 시 해당 상품의 판매량이 증가한다
- 동일 이벤트가 중복 수신되어도 집계는 한 번만 반영된다

**예외 상황:**

- 이벤트 처리 실패 시 DLQ로 전송된다

---

**유저 스토리 3: 재고 소진 시 품절 표시**

As a 구매자, I want to 재고가 소진된 상품은 품절로 표시되길 원한다, So that 구매 불가능한 상품에 시간을 낭비하지 않을 수 있다.

**인수 조건:**

- 재고 소진 이벤트 발생 시 해당 상품의 캐시가 무효화된다
- 캐시 무효화 후 상품 조회 시 품절 상태가 반영된다

**예외 상황:**

- 이벤트 처리 실패 시 DLQ로 전송된다

---

**유저 스토리 4: 조회수 집계**

As a 시스템, I want to 상품별 상세 페이지 조회수를 집계한다, So that 향후 추천/랭킹에 활용할 수 있다.

**인수 조건:**

- 상품 상세 페이지 조회 이벤트 발생 시 해당 상품의 조회수가 증가한다
- 동일 이벤트가 중복 수신되어도 집계는 한 번만 반영된다

**예외 상황:**

- 이벤트 처리 실패 시 DLQ로 전송된다

## 4. 기술 요구사항 명세

### 4.1 Producer 설정

acks=all, idempotence=true 설정을 적용한다.

### 4.2 Consumer 설정

manual Ack 처리를 적용한다.

### 4.3 데이터 정합성

Producer는 Transactional Outbox Pattern을 통해 At Least Once를 보장한다. Consumer는 event_handled 테이블을 통해 멱등성을 보장하고, version/updated_at 기준으로 중복 이벤트를 필터링한다. 집계 데이터는 Eventual Consistency로 반영된다.

### 4.4 에러 처리

이벤트 처리 실패 시 DLQ로 적재한다.
